---
import UsdNgnChart from '../components/UsdNgnChart.jsx';
import UsdNgnTable from '../components/UsdNgnTable.jsx';
import "../styles/global.css";

// SSR fetch from your API or KV (use absolute URL in production)
let history = [];
try {
  const res = await fetch("https://astro-blog-starter-template.mtndatasales.workers.dev/api/usd-ngn-history");
  history = await res.json();
} catch (e) {
  history = [];
}

// Get 30-day high/low
const sells = history.map(d => d.sell);
const buys = history.map(d => d.buy);
const sellHigh = Math.max(...sells);
const sellLow = Math.min(...sells);
const buyHigh = Math.max(...buys);
const buyLow = Math.min(...buys);

// Last 7 days
const last7 = history.slice(-7).reverse();
---

<html>
  <head>
    <title>Dollar to Naira Black Market Chart & Table</title>
    <meta name="description" content="30 days history of dollar to naira black market rates, graph, recent table, high/low rates." />
  </head>
  <body>
    <h1>USD/NGN Black Market Rate - Last 30 Days</h1>

    <section>
      <h2>30-Day Exchange Rate Chart</h2>
      <UsdNgnChart data={history} client:only="react" />
    </section>

    <section>
      <h2>7-Day Recent Table</h2>
      <UsdNgnTable data={last7} client:only="react" />
    </section>

    <section>
      <h2>30-Day High/Low</h2>
      <div>
        <b>Sell High:</b> ₦{sellHigh} &nbsp; <b>Sell Low:</b> ₦{sellLow}<br/>
        <b>Buy High:</b> ₦{buyHigh} &nbsp; <b>Buy Low:</b> ₦{buyLow}
      </div>
    </section>
  </body>
</html>

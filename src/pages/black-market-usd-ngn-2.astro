---
import "../styles/global.css";

function getBaseUrl(Astro) {
  if (Astro.site) return Astro.site;
  if (Astro.request) return new URL(Astro.request.url).origin;
  return "https://astro-blog-starter-template.mtndatasales.workers.dev";
}

// Fetch 30d USD/NGN history
let history = [];
try {
  const baseUrl = getBaseUrl(Astro);
  const res = await fetch(`${baseUrl}/api/usd-ngn-history`);
  if (res.ok) {
    history = await res.json();
  }
} catch (e) {
  history = [];
}

// Extract today's and yesterday's rates
const today = history.at(-1) || {}; // Last in array
const yesterday = history.at(-2) || {};
const todayDate = today.date ? new Date(today.date) : new Date();
const buyRate = today.buy ?? 'N/A';
const sellRate = today.sell ?? 'N/A';
const buyRateYesterday = yesterday.buy ?? null;

// Calculate percent change
let percentChange = '';
if (buyRateYesterday && typeof buyRate === 'number') {
  const pct = ((buyRate - buyRateYesterday) / buyRateYesterday) * 100;
  percentChange = (pct > 0 ? 'â†‘' : 'â†“') + ' ' + Math.abs(pct).toFixed(2) + '%';
}

// Format date (e.g. "2 June 2025")
function formatDate(dt) {
  return dt.toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' });
}
---

<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Dollar (USD) to Naira Black Market Rate - Last 30 Days</title>
  <meta name="description" content="See the latest USD to NGN black market exchange rates, graph, 30-day history, 7-day table, and all time high/low." />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
</head>
<body>
  <section class="currency-page">
    <div class="currency-header">
      <span class="currency-flag">ðŸ‡ºðŸ‡¸</span>
      <h1>USD to NGN Black Market Rate</h1>
    </div>
    
    <!-- Summary Section (Put this before the graph!) -->
    <div class="summary-box">
      <b>As of {formatDate(todayDate)}, the exchange rate for 1 US Dollar to Nigerian Naira is <span style="color:#166a39;">â‚¦{buyRate}</span>. 
      Compared to yesterday, this represents a <span style={percentChange.startsWith('â†“') ? 'color:red;' : 'color:green;'}>{percentChange || 'â€”'}</span> in value.</b>
      <div style="margin-top:0.8em">
        If you're planning to buy <b>1 Dollar</b> at street value, the current rate would cost you approximately <span style="color:#166a39;"><b>â‚¦{buyRate}</b></span>.
      </div>
      <div style="margin-top:0.5em">
        Do you have 1 Dollar to sell now? Here is the rate to sell: <span style="color:#166a39;"><b>â‚¦{sellRate}</b></span> for USD.
      </div>
    </div>

    <div id="chart-container">
      <em style="color:#8ba390;">[Chart coming soon]</em>
    </div>

    <!-- ... rest of your page ... -->
  </section>
</body>
</html>

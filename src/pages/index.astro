---
import "../styles/global.css";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";

const todayDate = new Date().toLocaleDateString("en-GB", { day: "numeric", month: "long", year: "numeric" });

const cityList = "Lagos, Abuja, Portharcourt, and Kano";

const currencies = [
  { code: "USD_NGN", label: "Dollar", flag: "ðŸ‡ºðŸ‡¸", name: "USD", url: "/black-market-usd-ngn-2" },
  { code: "GBP_NGN", label: "Pound", flag: "ðŸ‡¬ðŸ‡§", name: "GBP", url: "/black-market-gbp-ngn-2" },
  { code: "EUR_NGN", label: "Euro", flag: "ðŸ‡ªðŸ‡º", name: "EUR", url: "/black-market-eur-ngn-2" },
  { code: "CAD_NGN", label: "Canadian Dollar", flag: "ðŸ‡¨ðŸ‡¦", name: "CAD", url: "/black-market-cad-ngn-2" },
  { code: "ZAR_NGN", label: "Rand", flag: "ðŸ‡¿ðŸ‡¦", name: "ZAR", url: "/black-market-zar-ngn-2" },
  { code: "AUD_NGN", label: "Aussie", flag: "ðŸ‡¦ðŸ‡º", name: "AUD", url: "/black-market-aud-ngn-2" },
  { code: "AED_NGN", label: "Dirham", flag: "ðŸ‡¦ðŸ‡ª", name: "AED", url: "/black-market-aed-ngn-2" },
  { code: "CNY_NGN", label: "Yuan", flag: "ðŸ‡¨ðŸ‡³", name: "CNY", url: "/black-market-cny-ngn-2" },
  { code: "GHS_NGN", label: "Cedi", flag: "ðŸ‡¬ðŸ‡­", name: "GHS", url: "/black-market-ghs-ngn-2" },
  { code: "XOF_NGN", label: "XOF", flag: "ðŸŒ", name: "XOF", url: "/black-market-xof-ngn-2" },
  { code: "XAF_NGN", label: "XAF", flag: "ðŸŒ", name: "XAF", url: "/black-market-xaf-ngn-2" },
];

let rates = {};
let usdHistory = [];
try {
  const res = await fetch("https://astro-blog-starter-template.mtndatasales.workers.dev/api/latest-rates");
  rates = await res.json();
} catch (e) {
  rates = {};
}
try {
  const res = await fetch("https://astro-blog-starter-template.mtndatasales.workers.dev/api/usd-ngn-history");
  if (res.ok) {
    usdHistory = await res.json();
  }
} catch (e) {
  usdHistory = [];
}

const todaySell = rates.USD_NGN?.sell ?? "N/A";
const todayBuy = rates.USD_NGN?.buy ?? "N/A";
const yesterdaySell = usdHistory.length > 1 && typeof usdHistory.at(-2)?.sell === "number"
  ? usdHistory.at(-2).sell
  : "N/A";
const percentChange =
  yesterdaySell !== "N/A" && todaySell !== "N/A" && typeof todaySell === "number" && typeof yesterdaySell === "number"
    ? (((todaySell - yesterdaySell) / yesterdaySell) * 100).toFixed(2)
    : "N/A";

const last7 = usdHistory.slice(-7).reverse();

// --- Percent change for all pairs logic ---
let percentChanges = {};

async function getHistory(code) {
  if (code === "USD_NGN") return usdHistory;
  const short = code.replace("_NGN", "").toLowerCase();
  try {
    const res = await fetch(`https://astro-blog-starter-template.mtndatasales.workers.dev/api/${short}-ngn-history`);
    if (res.ok) return await res.json();
  } catch {}
  return [];
}

// NOTE: Astro runs all code at build-time, so top-level await is OK here
for (const { code } of currencies) {
  let history = [];
  if (code === "USD_NGN") {
    history = usdHistory;
  } else {
    history = await getHistory(code);
  }
  const today = history.at(-1);
  const yesterday = history.at(-2);
  let pct = null;
  if (
    today && yesterday &&
    typeof today.sell === "number" &&
    typeof yesterday.sell === "number"
  ) {
    const diff = today.sell - yesterday.sell;
    const percent = (diff / yesterday.sell) * 100;
    pct = {
      value: (percent > 0 ? "+" : "") + percent.toFixed(2) + "%",
      up: percent > 0,
      down: percent < 0,
    };
  } else {
    pct = { value: "N/A" };
  }
  percentChanges[code] = pct;
}
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Nairatoday - Dollar, Pound, Euro, and more to Naira Black Market Exchange Rate Today</title>
    <meta name="description" content="Track naira black market exchange rate: Dollar, Euro, Pound, and more to Naira. Live rates, daily updates." />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/src/styles/global.css">
  </head>
  <body>
    <Header />

    <!-- Summary always at the top for SEO -->
    <div class="daily-summary" style="margin:1.5em auto 2em auto;max-width:750px;padding:1em 1.2em 1em 1.2em;background:#fff5e6;color:#283b2e;border-radius:10px;font-size:1.08em;">
      <b>{todayDate}</b>, the Naira to Dollar Black market (Abokifx) exchange rate is
      <b>{todaySell !== "N/A" ? todaySell : "N/A"}</b> in {cityList}.
      This suggests that you can now buy at just <b>{todaySell !== "N/A" ? todaySell : "N/A"}</b>
      and sell for <b>{todayBuy !== "N/A" ? todayBuy : "N/A"}</b>.<br>
      Yesterday it sold for <b>{yesterdaySell !== "N/A" ? yesterdaySell : "N/A"}</b>,
      which is just <b>{percentChange !== "N/A" ? percentChange + "%" : "N/A"}</b> of today's rate.
    </div>

    <h1 class="main-heading visually-hidden">
      Dollar, Pound, Euro, and more to Naira Black Market Exchange Rate {todayDate}
    </h1>

    <div class="cards">
      {currencies.map(({ code, label, flag, name, url }, i) => (
        <>
          <div class="card" key={code}>
            <div class="flag">{flag}</div>
            <div class="label">{label} ({name})</div>
            <a href={url} class="rate-row-link">
              <div class="rate-row"><b>BUY</b> = â‚¦{rates[code]?.buy ?? 'N/A'}</div>
              <div class="rate-row"><b>SELL</b> = â‚¦{rates[code]?.sell ?? 'N/A'}</div>
              <div class="percent-row"
                style={`margin-top:3px;font-size:0.99em;font-weight:500;display:inline-block;
                  color: ${
                    percentChanges[code]?.up
                      ? '#1fa750'
                      : percentChanges[code]?.down
                        ? '#e44'
                        : '#888'
                  };
                `}
              >
                {percentChanges[code]?.value !== undefined
                  ? (percentChanges[code]?.up
                      ? "â–² "
                      : percentChanges[code]?.down
                        ? "â–¼ "
                        : "")
                    + percentChanges[code]?.value
                  : "N/A"}
              </div>
            </a>
            <div style="margin-top:12px;">
              <a href={url} class="to-naira-btn">
                {label} To Naira <span aria-hidden="true" style="font-size:1.1em;">âž”</span>
              </a>
            </div>
          </div>
          {/* Immediately after the Dollar card, insert your SEO-rich content block */}
          {i === 0 && (
            <section style="max-width:740px;margin:2em auto 1.3em auto;padding:1.3em 1.2em;background:#fff;border-radius:12px;">
              <h2>Dollar to Naira Black Market Rate Today<br/>
              How much is Dollar to Naira Today in Black Market</h2>
              <p>
                The Dollar to Naira Black Market rate remains unpredictable as it continues to remain volatile. As a Nigerian who is either involved in payment of school fees abroad or just wants to ship in items from overseas, you have to note that black market or Abokifx rate, officially known as the parallel market rate, often reflects real-time demand and supply on the go. Hence, the market is inherently volatile and most often, movements are against the Naira.
              </p>
              <h2>Dollar to Naira Black Market Buying Rate</h2>
              <p>
                Today's Dollar to Naira Black Market exchange rate traded at <b>â‚¦{todaySell !== "N/A" ? todaySell : "N/A"}</b> per $1. This simply means that one Dollar now sells for just <b>{todaySell !== "N/A" ? todaySell : "N/A"}</b>.
              </p>
              <h2>Dollar to Naira Black Market selling Rate</h2>
              <p>
                Today's Dollar to Naira Black Market <b>buying</b> exchange rate traded at <b>â‚¦{todayBuy !== "N/A" ? todayBuy : "N/A"}</b> per $1.
                This simply means that you can buy one Dollar for just <b>{todayBuy !== "N/A" ? todayBuy : "N/A"}</b>.
              </p>
            </section>
          )}
        </>
      ))}
    </div>

    <div class="welcome-box">
      <!-- ... (all your previous code/cards/summaries here) ... -->
    </div>

    <!-- Last 7 Days Table, inserted before info-section as requested -->
    <h2 style="max-width:720px;margin:2.2em auto 0.8em auto;padding:0 1.2em;">Last 7 Days Dollar to Naira Black Market Rate</h2>
    <table class="history-table" style="max-width:720px;margin:0 auto 2em auto;">
      <thead>
        <tr>
          <th>Date</th>
          <th>Buy</th>
          <th>Sell</th>
        </tr>
      </thead>
      <tbody>
        {last7.map(day => (
          <tr>
            <td>
              {day.date
                ? `${day.date.slice(6,8)} ${new Date(day.date.slice(0,4)+'-'+day.date.slice(4,6)+'-'+day.date.slice(6,8)).toLocaleString('en-GB',{month:'short'})} ${day.date.slice(0,4)}`
                : "-"}
            </td>
            <td>â‚¦{typeof day.buy === "number" ? day.buy : "N/A"}</td>
            <td>â‚¦{typeof day.sell === "number" ? day.sell : "N/A"}</td>
          </tr>
        ))}
      </tbody>
    </table>

    <!-- Info section starts here (nothing changed below this point) -->
    <!-- ... your unchanged info/faq sections ... -->

    <Footer />
    <script is:inline>
      document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.faq-item h3').forEach(h3 => {
          h3.addEventListener('click', function() {
            const item = this.parentElement;
            item.classList.toggle('open');
          });
          // Accessibility: toggle with Enter/Space key
          h3.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              this.click();
            }
          });
        });
      });
    </script>
  </body>
</html>

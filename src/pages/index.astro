---
import "../styles/global.css";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";

const API_BASE = "https://astro-blog-starter-template.mtndatasales.workers.dev";

// 1. Fetch today's rate for USD/NGN
let latest = {};
try {
  const res = await fetch(`${API_BASE}/api/latest-rates`);
  if (res.ok) {
    const data = await res.json();
    latest = data.USD_NGN ?? {};
  }
} catch (e) {
  latest = {};
}

// 2. Fetch 30-day USD/NGN history
let history = [];
try {
  const res = await fetch(`${API_BASE}/api/usd-ngn-history`);
  if (res.ok) {
    history = await res.json();
  }
} catch (e) {
  history = [];
}

// 3. Prepare dynamic data
const today = history.at(-1) || {};
const yesterday = history.length > 1 ? history.at(-2) : {};
const todayBuy = typeof latest.buy === "number" ? latest.buy : today.buy ?? "N/A";
const todaySell = typeof latest.sell === "number" ? latest.sell : today.sell ?? "N/A";
const yesterdaySell = typeof yesterday.sell === "number" ? yesterday.sell : null;
const cityList = "Lagos, Abuja, Portharcourt, and Kano";
const todayDate = today.date
  ? `${today.date.slice(6,8)} ${new Date(today.date.slice(0,4)+'-'+today.date.slice(4,6)+'-'+today.date.slice(6,8)).toLocaleString('en-GB',{month:'long'})} ${today.date.slice(0,4)}`
  : new Date().toLocaleDateString("en-GB", { day: "numeric", month: "long", year: "numeric" });

// 4. Percent change vs yesterday
let percentChange = "";
if (yesterdaySell && typeof todaySell === "number") {
  const pct = ((todaySell - yesterdaySell) / yesterdaySell) * 100;
  percentChange = Math.abs(pct).toFixed(2);
}

// 5. 30-day High/Low
const buyHigh = Math.max(...history.map(h => h.buy ?? -Infinity));
const buyLow = Math.min(...history.map(h => typeof h.buy === "number" ? h.buy : Infinity));
const sellHigh = Math.max(...history.map(h => h.sell ?? -Infinity));
const sellLow = Math.min(...history.map(h => typeof h.sell === "number" ? h.sell : Infinity));

// 6. Last 7 Days Table (newest first)
const last7 = history.slice(-7).reverse();

// 7. Generate rows for 1 to 100 multiplied by sellRate
const multiplierRows = [];
for (let i = 1; i <= 100; i++) {
  multiplierRows.push({
    amount: i,
    result: typeof todaySell === "number" ? (i * todaySell).toLocaleString() : "N/A"
  });
}
---

<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Dollar (USD) to Naira Black Market Rate - Abokifx</title>
    <meta name="description" content="USD to NGN black market exchange rates, graph, 30-day history, 7-day table, high/low, calculator, and more." />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  </head>
  <body>
    <Header />

    <!-- ANNOUNCEMENT BOX: style in CSS using .summary-announcement -->
    <div class="summary-announcement">
      <b>{todayDate}</b>, the Naira to Dollar Black market (Abokifx) exchange rate is
      <b>{todaySell !== "N/A" ? todaySell : "N/A"}</b> in {cityList}.
      This suggests that you can now buy at just <b>{todaySell !== "N/A" ? todaySell : "N/A"}</b>
      and sell for <b>{todayBuy !== "N/A" ? todayBuy : "N/A"}</b>.<br>
      Yesterday it sold for <b>{yesterdaySell !== null ? yesterdaySell : "N/A"}</b>,
      which is just <b>{percentChange ? percentChange + "%" : "N/A"}</b> of today's rate.
    </div>

    <section class="currency-page">
      <div class="currency-header">
        <h1>Dollar (USD) to Naira Black Market Exchange Rate {todayDate} Abokifx</h1>
      </div>

      <!-- Summary Box -->
      <div class="summary-box">
        <b>
          As of {todayDate}, the exchange rate for 1 US Dollar to Nigerian Naira is
          <span class="main-buy-rate">₦{todayBuy}</span>.
          Compared to yesterday, this represents a
          <span class={percentChange && todaySell < yesterdaySell ? "rate-down" : "rate-up"}>
            {percentChange ? (todaySell < yesterdaySell ? "↓" : "↑") + " " + percentChange + "%" : "—"}
          </span> in value.
        </b>
        <div>
          If you're planning to buy <b>1 Dollar</b> at street value, the current rate would cost you approximately
          <span class="main-buy-rate"><b>₦{todayBuy}</b></span>.
        </div>
        <div>
          Do you have 1 Dollar to sell now? Here is the rate to sell:
          <span class="main-sell-rate"><b>₦{todaySell}</b></span> for USD.
        </div>
      </div>

      <!-- Chart placeholder -->
      <div id="chart-container">
        <em>[Chart coming soon]</em>
      </div>

      <!-- High/Low Stats -->
      <div class="stats-box">
        <div><b>30d High (Buy):</b> ₦{buyHigh === -Infinity ? "N/A" : buyHigh}</div>
        <div><b>30d Low (Buy):</b> ₦{buyLow === Infinity ? "N/A" : buyLow}</div>
        <div><b>30d High (Sell):</b> ₦{sellHigh === -Infinity ? "N/A" : sellHigh}</div>
        <div><b>30d Low (Sell):</b> ₦{sellLow === Infinity ? "N/A" : sellLow}</div>
      </div>

      <!-- Last 7 Days Table -->
      <table class="history-table">
        <thead>
          <tr>
            <th>Date</th>
            <th>Buy</th>
            <th>Sell</th>
          </tr>
        </thead>
        <tbody>
          {last7.map(day => (
            <tr>
              <td>
                {day.date
                  ? `${day.date.slice(6,8)} ${new Date(day.date.slice(0,4)+'-'+day.date.slice(4,6)+'-'+day.date.slice(6,8)).toLocaleString('en-GB',{month:'short'})} ${day.date.slice(0,4)}`
                  : "-"}
              </td>
              <td>₦{typeof day.buy === "number" ? day.buy : "N/A"}</td>
              <td>₦{typeof day.sell === "number" ? day.sell : "N/A"}</td>
            </tr>
          ))}
        </tbody>
      </table>

      <!-- Amount Calculator Table -->
      <h2>Quick USD to Naira Converter Table</h2>
      <table class="calc-table">
        <thead>
          <tr>
            <th>Amount (USD)</th>
            <th>Equivalent (₦)</th>
          </tr>
        </thead>
        <tbody>
          {multiplierRows.map(row => (
            <tr>
              <td>{row.amount}</td>
              <td>₦{row.result}</td>
            </tr>
          ))}
        </tbody>
      </table>
    </section>

    <Footer />
  </body>
</html>
